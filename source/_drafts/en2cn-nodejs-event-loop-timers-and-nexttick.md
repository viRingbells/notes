---
title: 渣翻译 - Nodejs的事件循环
categories:
  - 理论
tags:
  - 学习
---

最近想深入了解一下Nodejs的event loop，发现了官网上的[一篇文章](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)。在Nodejs的[中文官网](http://nodejs.cn)上也没有收录。考虑日后也要常来翻阅，英语阅读起来确实也不直观，所以尝试翻译一下。（原汁原味是不可能的，肯定会有自己的理解参杂在里面）

> 正文来自Nodejs官网[https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/]

------分割线------

## 什么是事件循环(Event Loop)

事件循环是一种机制，利用这种机制，即使是单线程的Nodejs，也可以通过尽可能的将IO工作下放到操作系统，来实现非阻塞的执行IO操作的能力。

绝大多数现代操作系统都支持多进程，它们可以在后台并行执行多个任务。当一个任务运行结束时，操作系统会通知Nodejs将正确的回调函数添加到轮询队列，并最终被执行[[1]](#note-1)。关于这个我们稍后详细说明。

## 事件循环说明

当Nodejs启动时，它就会初始化事件循环，执行目标脚本（或者进入REPL模式，这个不在本文讨论范围之内）。在目标脚本内可能会有调用异步API、调用Timers、或者调用`process.nextTick()`的行为。然后Nodejs就会开始处理事件循环。

下图[[2]](#note-2)简要的展示了事件循环按照顺序的各个环节。

```
   ┌───────────────────────────┐
┌─>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │<─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
```

_说明：每一个方框对应到事件循环的一个环节_

每一个环节里，通常都会有一个该环节特有的行为。同时所有环节都有一个先进先出的队列，这个队列里是将要执行的回调函数。当事件循环进入到一个环节的时候，先执行该环节的特有行为，然后就开始执行队列中的回调函数，直到全部执行完毕，或者超出执行次数上限。之后，事件循环会进入到下一个环节，然后重复这一过程。

任何行为都可能调度更多的操作，并且轮询阶段产生的新事件也会由内核添加到队列（？），因此在处理轮询事件的时候，也会有新的轮询时间添加到队列中。结果就是，长时间运行的回调函数会使轮询阶段运行得比定时器设置的时间要长的多。查阅[定时器](#定时器)和[轮询](#轮询)了解更多细节。

_说明：在Windows和Linux/Unix上的实现上有微小的差异，但是对于本段示例来说并不重要。重要的是，虽然实际上有七个或者八个环节，但是我们真正关心的，也就是Nodejs实际上用到的，只有上面实例的那些。_

## 各环节概览

* **定时器(timers)**: 这个环节执行通过`setTimeout`和`setInterval`设置的回调函数。
* **即将执行的回调函数(pending callbacks)**: 执行延迟到下一个迭代循环的IO回调函数。（我也读不懂，等我回来修改）

## 说明

* <span id='note-1'>[1]</span> 原文用的"May be added to the poll queue"，所以说Nodejs处理回调函数的行为只是有可能发生。因为有时不关心任务何时结束，就没有回调函数。大多数情况下都应该是要有回调函数的。我为什么没有用『可能』？因为这个可能放在那里虽然准确，但是太奇怪了，会感觉这个『可能』的可能性远远超过了它应该的可能性。
* <span id='note-2'>[2]<span> 中文会导致格式乱掉，这里的各个环节在后面会详细说到，就不翻译了。
