---
title: Session Storage 追踪窗口
date: 2019-12-22 16:24:05
categories:
    - 工程
    - 前端
tags:
    - 笔墨纸砚
    - 鉴往知来
---

# Session Storage 追踪窗口

我们在做用户产品的时候，经常需要用户在多个不同的产品之间跳转，比如『首页->分类列表->详情页->转化页』这样的路径。考虑到每一个节点实际上都是为最后转化服务，所以我们需要收集转化前所有节点的信息，这个信息称为线索。对于客户端，我们可以以客户端粒度记录线索。而在浏览器，我们一般使用 LocalStorage 之类的前端存储技术来记录，本质上是以域名为粒度记录线索。

但是 web 上存在一种特殊情况，即用户可以同时打开多个窗口。由于这些窗口共享同一套存储数据，以域名粒度追踪线索的方式便无法准确的工作。比如如下路径：

```
首页 -> 分类列表 -> 详情页A -> 转化页A
          |    -> 详情页B -> 转化页B
```

假设用户路径是：『首页->分类列表->（窗口1）详情页A->回到分类列表->（窗口2）详情页2->（窗口1）转化页A』，也就是说用户在操作的时候手动的切换了窗口。

如果我们通过 LocalStorage 来记录线索，比如点击详情页，作为分类列表排序的依据，那么会出现『详情页B』的点击数据覆盖了『详情页A』的数据，导致转化对应的线索错误的指向了点击『详情页B』。事实上即是记录用户行为的完整步骤（即上面那个路劲），由于浏览器不会传递窗口信息，我们也很难明确的识别用户路径。

那么为了解决这个问题，应该怎么办呢？

一种办法就是舍弃客户端存储技术，利用跳转时的 url 参数来传递。这需要链路上所有的产品都遵守共同的一个约定，在涉及跨团队甚至跨公司合作的时候，成本极大。考虑如下场景，就会觉得此方案甚至是不可行的。

```
A 公司产品引流             A公司的转化页
               \        /
                 详情页
               /        \
B 公司产品引流             B公司的转化页
```

为了解决这个问题，我研究了一下 SessionStorage。众所周知，SessionStorage 与 LocalStorage 的机制基本相同，只是 SessionStorage 在页面关闭时会删除数据，那么不涉及窗口关闭的这个需求，使用 SessionStorage 有什么不同呢？
